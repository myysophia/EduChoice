package email

import (
	"context"
	"fmt"
	"github.com/big-dust/DreamBridge/internal/pkg/common"
	"github.com/big-dust/DreamBridge/pkg/rand"
	"github.com/jordan-wright/email"
	"net/smtp"
	"net/textproto"
	"time"
)

func Send(toEmail string) error {
	ec := common.CONFIG.StringMap("email")
	//发送
	randCode := rand.String(6)
	html := "<div style=\"position: relative;\">\n    <table width=\"720px\" align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n        <tbody>\n            <tr>\n                <td class=\"p-80 mpy-35 mpx-15\" bgcolor=\"#FFFFFF\" align=\"center\">\n                    <table width=\"720px\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\">\n                        <tbody>\n                            <tr>\n                                <td style=\"width: 720px;\" align=\"center\">\n                                    <svg>\n                                        <path\n                                            d=\"" +
		"\"\n                                            stroke=\"none\" fill=\"#f6c148\" fill-rule=\"evenodd\"></path>\n                                        <path\n                                        " +
		"    d=\"" +
		"\"\n                                            stroke=\"none\" fill=\"#ffffff\" fill-rule=\"evenodd\"></path>\n                                    </svg>\n                                </td>\n                            </tr>\n                            <tr>\n                                <td>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                        <tbody>\n                                            <tr>\n                                                <td\n                                                    style=\"font-size:20px; line-height:42px; font-family:Arial, sans-serif, 'Motiva Sans'; text-align:left; padding-bottom: 30px; color:#002333; font-weight:bold;\">\n                                                    <span style=\"color: #F4AB4C;\">\n                                                        同学你好\n                                                    </span>\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                        <tbody>\n                                            <tr>\n                                                <td class=\"text-18 c-grey4 pb-30\"\n                                                    style=\"vertical-align: bottom;font-size:18px; line-height:25px; font-family:Arial, sans-serif, 'Motiva Sans'; text-align:left; color:#002333; padding-bottom: 30px;\">\n                                                    您正在进行 验证操作，这是您验证帐户所需的验证码，有效时间为 30 分钟。\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\">\n                                        <tbody>\n                                            <tr>\n                                                <td class=\"pb-70 mpb-50\" style=\"padding-bottom: 70px;\" align=\"center\">\n                                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\"\n                                                        style=\"background-color: #fae8d2;\">\n                                                        <tbody>\n                                                            <tr>\n                                                                <td class=\"py-30 px-56\"\n                                                                    style=\"padding-top: 30px; padding-bottom: 30px; \">\n                                                                    <table width=\"720px\" border=\"0\" cellspacing=\"0\"\n                                                                        cellpadding=\"0\">\n                                                                        <tbody>\n                                                                            <tr>\n                                                                                <td\n                                                                                    style=\"font-size:18px; line-height:25px; font-family:Arial, sans-serif, 'Motiva Sans'; color:#8f98a0; text-align:center;\">\n                                                                                    验证码\n                                                                                </td>\n                                                                            </tr>\n                                                                            <tr>\n                                                                                <td style=\"padding-bottom: 16px\">\n                                                                                </td>\n                                                                            </tr>\n                                                                            <tr>\n                                                                                <td class=\"title-48 c-blue1 fw-b a-center\"\n                                                                                    style=\"font-size:48px; line-height:52px; font-family:Arial, sans-serif, 'Motiva Sans'; color:#f5a338; font-weight:bold; text-align:center;\">\n                                                                                    " + randCode + "\n                                                                                </td>\n                                                                            </tr>\n                                                                        </tbody>\n                                                                    </table>\n                                                                </td>\n                                                            </tr>\n                                                        </tbody>\n                                                    </table>\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                        <tbody>\n                                            <tr>\n                                                <td class=\"title-36 pb-30 c-grey6 fw-b\"\n                                                    style=\"font-size:30px; line-height:34px; font-family:Arial, sans-serif, 'Motiva Sans'; text-align:left; padding-bottom: 20px; color:#002333; font-weight:bold;\">\n                                                    不是您？\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                        <tbody>\n                                            <tr>\n                                                <td class=\"text-18 c-grey4 pb-30\"\n                                                    style=\"font-size:18px; line-height:25px; font-family:Arial, sans-serif, 'Motiva Sans'; text-align:left; color:#002333; padding-bottom: 30px;\">\n                                                    如果这不是来自您的验证请求，请您忽略本邮件并\n                                                    <span style=\"color: #002333; font-weight: bold;\">\n                                                        不要将验证码转发给任何人\n                                                    </span>\n                                                    。\n                                                    <br>\n                                                    <br>\n                                                    此电子邮件包含一个代码，您需要用它验证您的帐户。切勿与任何人分享此代码。\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                        <tbody>\n                                            <tr>\n                                                <td class=\"pt-30\" style=\"padding-top: 30px;\">\n                                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                                                        <tbody>\n                                                            <tr>\n                                                                <td width=\"5px\" height=\"120px\"\n                                                                    style=\"background-color: #f5a338;text-align:left;\">\n                                                                </td>\n                                                                <td class=\"img\" width=\"37\" style=\"text-align:left;\">\n                                                                </td>\n                                                                <td>\n                                                                    <table width=\"100%\" border=\"0\" cellspacing=\"0\"\n                                                                        cellpadding=\"0\">\n                                                                        <tbody>\n                                                                            <tr>\n                                                                                <td class=\"text-16 py-20 c-grey4 fallback-font\"\n                                                                                    style=\"font-size:16px; line-height:22px; font-family:Arial, sans-serif, 'Motiva Sans'; text-align:left; padding-top: 20px; padding-bottom: 20px; color:#002333;\">\n                                                                                    祝您愉快，\n                                                                                    <br>\n                                                                                    梦之桥团队\n                                                                                </td>\n                                                                            </tr>\n                                                                        </tbody>\n                                                                    </table>\n                                                                </td>\n                                                            </tr>\n                                                        </tbody>\n                                                    </table>\n                                                </td>\n                                            </tr>\n                                        </tbody>\n                                    </table>\n                                </td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </td>\n            </tr>\n            <tr>\n            </tr>\n        </tbody>\n    </table>\n</div>"
	e := &email.Email{
		To:      []string{toEmail},
		From:    ec["username"],
		Subject: "梦之桥 - 用户注册",
		HTML:    []byte(html),
		Headers: textproto.MIMEHeader{},
	}
	err := e.Send(ec["host"]+":"+ec["port"], smtp.PlainAuth("", ec["username"], ec["password"], ec["host"]))
	if err != nil {
		return err
	}
	//存到redis
	ctx := context.Background()
	key := fmt.Sprintf("%s/%s", common.Dream, toEmail)
	common.REDIS.Set(ctx, key, randCode, time.Minute*30)
	return err
}
