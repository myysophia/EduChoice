# 专业推荐功能开发记录

## 一、功能实现过程

### 1. 数据模型设计
1. 历年录取信息模型
   ```go
   // internal/model/major/major.go
   type HistoryInfo struct {
       LowestScore    int `json:"lowest_score"`    // 最低分
       LowestRank     int `json:"lowest_rank"`     // 最低位次
       EnrollmentNum  int `json:"enrollment_num"`  // 录取人数
   }
   ```

2. 学校信息模型
   ```go
   type School struct {
       ID           int                         `json:"id"`
       Name         string                      `json:"name"`
       HistoryInfos map[string]HistoryInfo     `json:"history_infos"` // key: 年份
       Parts        map[string][]Major          `json:"parts"`        // key: 批次
   }
   ```

3. 推荐响应模型
   ```go
   type RecommendResp struct {
       ChongSchools []School `json:"chong_schools"` // 冲刺院校
       WenSchools   []School `json:"wen_schools"`   // 稳妥院校
       BaoSchools   []School `json:"bao_schools"`   // 保底院校
   }
   ```

### 2. API 接口实现
1. 专业推荐处理器
   ```go
   // internal/api/handler/major/major.go
   func GetRecommend(c *gin.Context) {
       // 获取用户ID
       uid := c.GetInt("uid")
       if uid == 0 {
           response.Error(c, "用户未登录")
           return
       }

       // 获取用户信息
       u, err := user.FindOne(uid)
       if err != nil {
           response.Error(c, "获取用户信息失败")
           return
       }

       // 检查信息完整性
       if !u.IsComplete() {
           response.Error(c, "请先完善个人信息")
           return
       }

       // 返回推荐数据
       response.Success(c, resp)
   }
   ```

2. 路由注册
   ```go
   // internal/router/router.go
   func registerMajorRoutes(r *gin.RouterGroup) {
       zy := r.Group("/zy")
       zy.GET("/recommend", middleware.JWT(), major.GetRecommend)
   }
   ```

## 二、问题解决记录

### 1. 用户信息完整性检查
- 问题：未完善信息的用户也能获取推荐
- 原因：缺少信息完整性验证
- 解决方案：
  ```go
  // internal/model/user/user.go
  func (u *User) IsComplete() bool {
      return u.Score > 0 && 
             u.ProvinceRank > 0 && 
             u.Province != "" &&
             u.ExamType != ""
  }
  ```

### 2. JSON 字段命名规范
- 问题：前端无法正确解析数据
- 原因：Go struct 字段默认使用大驼峰，需要显式指定 JSON tag
- 解决方案：
  ```go
  type School struct {
      ID           int    `json:"id"`
      Name         string `json:"name"`
      HistoryInfos map[string]HistoryInfo `json:"history_infos"`
  }
  ```

### 3. 错误处理优化
- 问题：错误信息不够明确
- 解决方案：
  ```go
  // internal/api/response/response.go
  func Error(c *gin.Context, msg string) {
      c.JSON(http.StatusOK, gin.H{
          "code": 1,
          "msg":  msg,
          "data": nil,
      })
  }
  ```

### 4. 日志记录完善
- 问题：调试信息不足
- 解决方案：
  ```go
  func GetRecommend(c *gin.Context) {
      // 添加关键步骤日志
      fmt.Printf("用户信息: %+v\n", u)
      fmt.Printf("返回推荐数据: %+v\n", resp)
  }
  ```

## 三、优化记录

### 1. 代码结构优化
- 模型定义集中管理
- 处理器逻辑分层
- 路由注册规范化

### 2. 响应格式优化
- 统一错误码
- 规范化响应结构
- 明确的错误提示

### 3. 性能优化
- 添加必要的数据验证
- 优化数据库查询
- 减少不必要的类型转换

## 四、待优化项目
1. [ ] 实现真实的推荐算法
2. [ ] 添加数据库缓存
3. [ ] 优化查询性能
4. [ ] 完善错误处理
5. [ ] 添加数据验证

## 五、经验总结
1. 接口设计要考虑前端使用便利性
2. 错误处理要提供明确的提示信息
3. 数据模型设计要考虑扩展性
4. 日志记录要助于问题定位
5. 代码结构要便于维护和扩展 